<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="爬虫实践之头条狗狗图片">
<meta itemprop="description" content="最近在学习爬虫，学了就应该多实践实践，本文将记录使用requests 库下载头条上搜到的狗狗图片的实现过程，使用python3实现。">


<meta itemprop="datePublished" content="2018-06-21T14:41:32&#43;08:00" />
<meta itemprop="dateModified" content="2018-06-21T14:41:32&#43;08:00" />
<meta itemprop="wordCount" content="6591">



<meta itemprop="keywords" content="python,spider," />
<meta property="og:title" content="爬虫实践之头条狗狗图片" />
<meta property="og:description" content="最近在学习爬虫，学了就应该多实践实践，本文将记录使用requests 库下载头条上搜到的狗狗图片的实现过程，使用python3实现。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.smslit.top/2018/06/21/spider-practice-pic-dog/" />
<meta property="article:published_time" content="2018-06-21T14:41:32&#43;08:00"/>
<meta property="article:modified_time" content="2018-06-21T14:41:32&#43;08:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="爬虫实践之头条狗狗图片"/>
<meta name="twitter:description" content="最近在学习爬虫，学了就应该多实践实践，本文将记录使用requests 库下载头条上搜到的狗狗图片的实现过程，使用python3实现。"/>
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>爬虫实践之头条狗狗图片</title>
	<link rel="stylesheet" href="https://www.smslit.top/css/style.min.645b14dc26ce57a45585b37a4ef11a96fee72376dcd62ffbcd5103cd5edf7f1c.css" integrity="sha256-ZFsU3CbOV6RVhbN6TvEalv7nI3bc1i/7zVEDzV7ffxw=">
	
	<link rel="stylesheet" href="https://www.smslit.top/css/valine.css">
	<link rel="stylesheet" href="https://www.smslit.top/css/reward.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.smslit.top">SMSLIT</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.smslit.top/post/">Posts</a>
					<a href="https://www.smslit.top/tags/">Tags</a>
					<a href="https://www.smslit.top/about/">Me</a>
					<a href="https://smslit.coding.me/LeetCodeDaily/">LeetCode</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="目录"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="http://weibo.com/u/2684217817" target="_blank" rel="noopener" title="Weibo"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg"  fill="none" fill-rule="evenodd" class="feather feather-mail">
    <g transform="translate(0.000000, 2.000000)" fill="#000000" fill-rule="nonzero" id="形状">
        <path d="M23.7,8.59152679 C23.6,8.94964029 23.25,9.20543566 22.9,9.25659472 C22.55,9.30775379 22.2,9.10311751 22,8.745004 C21.9,8.54036772 21.85,8.28457235 21.95,8.02877698 C22.45,6.44284573 22.1,4.70343724 21,3.4756195 C19.9,2.24780175 18.3,1.68505194 16.7,2.04316547 C16.45,2.09432453 16.2,2.04316547 16,1.88968825 C15.8,1.73621103 15.65,1.53157475 15.6,1.27577938 C15.5,0.764188657 15.8,0.252597914 16.3,0.150279784 C18.45,-0.310151871 20.75,0.354916067 22.35,2.14548362 C23.95,3.98721024 24.35,6.44284573 23.7,8.59152679 Z M17.35,5.06155077 C17.15,5.11270983 16.95,5.06155077 16.75,4.95923261 C16.55,4.85691446 16.45,4.65227818 16.4,4.44764189 C16.3,3.98721024 16.6,3.57793765 17,3.4756195 C18.1,3.21982412 19.2,3.62909671 19.95,4.44764189 C20.7,5.31734614 20.9,6.4940048 20.6,7.56834532 C20.55,7.77298161 20.4,7.92645882 20.2,8.02877698 C20,8.13109513 19.8,8.13109513 19.6,8.07993604 C19.2,7.92645882 18.95,7.46602717 19.1,7.0567546 C19.25,6.54516388 19.15,5.93125501 18.8,5.52198242 C18.4,5.11270983 17.85,4.95923261 17.35,5.06155077 Z M18.05,9.66586731 C19.45,10.126299 20.95,11.1494804 20.95,13.0423661 C20.95,16.1119105 16.6,20 10.1,20 C5.1,20 1.13686838e-13,17.5443645 1.13686838e-13,13.4516387 C1.13686838e-13,11.3029576 1.30000001,8.84732213 3.6,6.54516386 C6.6,3.42446043 10.15,2.04316547 11.45,3.37330137 C12.05,3.98721024 12.1,5.0103917 11.7,6.23820942 C11.5,6.8521183 12.25,6.4940048 12.25,6.4940048 C14.7,5.41966427 16.85,5.3685052 17.6,6.54516386 C18,7.15907273 17.95,8.02877698 17.6,9.00079935 C17.45,9.46123101 17.7,9.56354916 18.05,9.66586731 Z M10.1,18.5163869 C14.05,18.1071143 17.1,15.6003197 16.85,12.940048 C16.6,10.2797762 13.15,8.43804957 9.19999999,8.84732213 C5.25,9.25659472 2.19999998,11.7633893 2.44999999,14.4236611 C2.7,17.0839329 6.09999998,18.9256595 10.1,18.5163869 Z M10.5,10.8936851 C12.45,11.4052758 13.45,13.2981615 12.65,15.1398881 C11.85,17.0327738 9.49999999,18.0047962 7.54999999,17.3908873 C5.64999998,16.7769784 4.84999999,14.8329336 5.65000001,13.0935252 C6.45,11.3541167 8.60000002,10.3820943 10.5,10.8936851 Z M9.04999999,15.3445244 C9.45,14.7306155 9.24999998,13.9632294 8.59999999,13.7074341 C7.99999999,13.4516387 7.2,13.7074341 6.79999999,14.3213429 C6.39999998,14.9352518 6.6,15.6514788 7.2,15.9584333 C7.84999999,16.2653877 8.65000001,16.0095923 9.04999999,15.3445244 Z" fill="currentColor"></path>
    </g>
</svg></a><a href="https://www.zhihu.com/people/smslit/activities" target="_blank" rel="noopener" title="Zhihu"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="none" fill-rule="evenodd" class="feather feather-mail">
    <path d="M12.1197571,11.3394973 C11.2394396,11.2471275 8.50587146,11.3394973 8.50587146,11.3394973 L8.50587146,5.8004836 L12.5830381,5.8004836 C12.5830381,5.8004836 12.5367176,3.95412048 11.7490411,3.95412048 L5.12356308,3.95412048 L6.23550841,1 C6.23550841,1 4.56753979,1.09236985 3.96524661,2.15395489 C3.36295344,3.21553992 1.46333165,8.52386857 1.46333165,8.52386857 C1.46333165,8.52386857 2.11199596,8.80082682 3.17759547,8.0161496 C4.2432456,7.2314976 4.6138603,5.84665591 4.6138603,5.84665591 L6.5598026,5.75428606 L6.60612311,11.3856444 C6.60612311,11.3856444 3.22394129,11.3394973 2.52895647,11.3856444 C1.83397166,11.4317915 1.46330634,13.2781799 1.46330634,13.2781799 L6.60619904,13.2781799 C6.60619904,13.2781799 6.14281677,16.4169392 4.8455894,18.6787523 C3.50191497,20.9405149 1,22.7406553 1,22.7406553 C1,22.7406553 2.80693015,23.4791854 4.56761573,22.4636971 C6.32822537,21.4020364 7.62555398,16.8323387 7.62555398,16.8323387 L11.7491424,21.9559781 C11.7491424,21.9559781 12.1197824,19.5096018 11.7028219,18.8172188 C11.2394396,18.1248358 8.83019096,15.3553541 8.83019096,15.3553541 L7.76454082,16.2784726 L8.50584615,13.2319823 L12.9999986,13.2319823 C13.0000745,13.2320328 13.0000745,11.4318672 12.1197571,11.3394973 Z M14.0447646,4 L14,20.8940959 L15.6119399,20.8940959 L16.1940015,23 L19.014927,20.8940959 L23,20.8940959 L23,4 L14.0448624,4 L14.0447646,4 Z M21,18.2118088 L19.2203194,18.2118088 L16.9745545,20 L16.4660842,18.2118088 L16,18.2118088 L16,6 L21,6 L21,18.2118088 Z" id="形状" fill="currentColor" fill-rule="nonzero"></path>    
</svg></a><a href="mailto:5km@smslit.cn" target="_blank" rel="noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="https://github.com/smslit" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="菜单"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.smslit.top/post/">Posts</a></li>
			<li><a href="https://www.smslit.top/tags/">Tags</a></li>
			<li><a href="https://www.smslit.top/about/">Me</a></li>
			<li><a href="https://smslit.coding.me/LeetCodeDaily/">LeetCode</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jun 21, 2018</span></div>
				<h1>爬虫实践之头条狗狗图片</h1>
			</header>
			<div class="content">
				<p>最近在学习爬虫，学了就应该多实践实践，本文将记录使用<code>requests</code> 库下载头条上搜到的狗狗图片的实现过程，使用<strong>python3</strong>实现。</p>

<h2 id="前言">前言</h2>

<p>我们知道现在有部分网页访问的时候返回的并不是完整的html，其利用javascript获取局部数据最终实现完整页面的呈现，而这依赖的是<code>AJAX</code>技术：</p>

<blockquote>
<p>AJAX，即“Asynchronous Javascript And XML”（异步 JavaScript 和 XML），是一种创建交互式网页应用的网页开发技术。</p>

<p>通过在后台与服务器进行少量数据交换，AJAX 可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。</p>

<p>@W3Cschool <a href="https://www.w3cschool.cn/ajax/nr583fns.html" target="_blank">AJAX简介</a></p>
</blockquote>

<p>而头条的搜图页面也是采用 <code>AJAX</code> 技术，下面分析一下网页。</p>

<h2 id="网页分析">网页分析</h2>

<p>首先，浏览器（本文使用的是<a href="https://www.google.cn/chrome/" target="_blank">google chrome</a>）打开头条图片频道的网址：<a href="https://www.toutiao.com/ch/news_image/" target="_blank">https://www.toutiao.com/ch/news_image </a>。打开页面会在右上角看到搜索框，在搜索框中输入<code>狗狗</code>，进行搜索，就会得到下面的页面：</p>

<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/2018062115295708613054.png" alt="search0" /></p>

<p>右击页面选择<code>检查</code>，就会出现一个网页检查窗口，有很多标签页，依次找到<code>Network</code>-<code>XHR</code>，此时点击上图页面中的<code>图集</code>，就会发现网页检查窗口中左栏出现一个<code>XHR</code>，如下：</p>

<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/20180622152964929637874.png" alt="20180622152964929637874.png" /></p>

<p>点击图中圈出的XHR，就会出现此条AJAX请求的详细内容，选择<code>Headers</code> 标签页：</p>

<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/20180621152957098380206.png" alt="XHR-detail" /></p>

<p>可以看到有请求头和响应头的信息，而 <code>Preview</code> 标签页内显示的则是请求结果，很明显的响应结果是个json格式的内容，chrome已经清晰的排版了json内容，对照网页呈现的内容查看一下json内容。</p>

<h3 id="响应结果分析">响应结果分析</h3>

<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/20180621152957267413410.png" alt="json" /></p>

<p>按照层级查看json内容，展开 <code>data</code> 就会发现有20个内容，正好与网页中显示的20个条目对应，展开 <code>0</code> 查看一下，可以看到两个关键信息：</p>

<ul>
<li><code>title</code>：对应网页条目的标题</li>
<li><code>image_list</code>: 对应网页中图片的链接</li>
</ul>

<p>查看 <code>data</code> 中的其它项，会发现都是与网页显示内容的条目一一对应，这样就一目了然了，可以通过AJAX请求获取json内容，然后解析json内容中的<code>data</code>里每个条目里的 <code>title</code>和<code>image_list</code>就可以得到图片链接了，这样就可以根据链接获取图片了，那么还得分析一下AJAX请求有什么规律。</p>

<h3 id="请求头分析">请求头分析</h3>

<p>切换到<code>Headers</code> 标签页，可以看到<code>Requests URL</code>为：</p>

<ul>
<li><a href="https://www.toutiao.com/search_content/?offset=0&amp;format=json&amp;keyword=%E7%8B%97%E7%8B%97&amp;autoload=true&amp;count=20&amp;cur_tab=3&amp;from=gallery" target="_blank">https://www.toutiao.com/search_content/?offset=0&amp;format=json&amp;keyword=%E7%8B%97%E7%8B%97&amp;autoload=true&amp;count=20&amp;cur_tab=3&amp;from=gallery</a></li>
</ul>

<p>滚动网页到最底以后，网页会增加20个新的条目，这时候会发现出现了一个新的 <code>XHR</code>，点击这个新的请求，查看头信息中的 <code>Requests URL</code>为：</p>

<ul>
<li><a href="https://www.toutiao.com/search_content/?offset=20&amp;format=json&amp;keyword=%E7%8B%97%E7%8B%97&amp;autoload=true&amp;count=20&amp;cur_tab=3&amp;from=gallery" target="_blank">https://www.toutiao.com/search_content/?offset=20&amp;format=json&amp;keyword=%E7%8B%97%E7%8B%97&amp;autoload=true&amp;count=20&amp;cur_tab=3&amp;from=gallery</a></li>
</ul>

<p>同时查看 <code>Preview</code> 标签页里的json数据，会发现与网页中新增加的20个条目是对应的，同理在继续滚动加载，又会多一个XHR，响应的json与新增加的条目对应。</p>

<p>对比每次增加的<code>XHR</code>中的请求链接，会发现链接只有一个 <code>offset</code> 参数在变，一个比一个多20，不难想20其实就是对应了 <code>count</code> 参数，其中还有一个 <code>keyword</code> 参数，对应的汉字其实就是 <code>狗狗</code>，那么看到这儿也就明白了，请求链接可以通过改变 <code>offset</code> 参数来生成，请求回来的json数据中就包含了对应offset下的20条数据，然后解析数据得到相应标题下的所有图片链接就可以了。</p>

<h2 id="爬虫实现">爬虫实现</h2>

<p>根据对网页的分析，就可以针对性的设计爬虫程序了。</p>

<h3 id="爬虫思路">爬虫思路</h3>

<p>根据上一节的分析，可以分三步实现图片的爬取：</p>

<ol>
<li>按照上一节分析的结果按照索引生成请求链接，请求网页获取响应结果；</li>
<li>从响应结果中提取关键信息：

<ul>
<li>标题</li>
<li>图片链接</li>
</ul></li>
<li>根据图片链接获取图片，并保存到以标题进行命名的目录中；</li>
</ol>

<h3 id="库的选择">库的选择</h3>

<p>首先要生成请求链接，观察链接格式，可以选择库 <code>urllib</code>parse模块的方法 <code>urlencode</code>方法生成，然后选择 <code>requests</code> 库进行网页请求，返回的结果是json，其实对应的是字典数据，提取信息不需要额外的库，同样使用 <code>requests</code> 库请求图片链接获取图片，为了好管理图片还得生成目录，需要使用 <code>os</code>库。本地保存的话，为了防止命名冲突，这里根据图片数据的md5码命名，那么会用到 <code>hashlib</code> 库，总结会用到以下库和方法：</p>

<ul>
<li><code>requests</code></li>
<li><code>urllib.parse</code>的<code>urlencode</code></li>
<li><code>hashlib</code>的<code>md5</code></li>
<li><code>os</code></li>
</ul>

<p>上述库中，只需要安装<code>requests</code>和<code>urllib</code>这两个库，一般通过pip3安装。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ pip3 install requests urllib</code></pre></div>
<h3 id="爬虫实现-1">爬虫实现</h3>

<p>首先将上述库和方法导入。</p>
<div class="highlight"><pre class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">import</span> <span class="nn">os</span></code></pre></div>
<h4 id="请求页面内容">请求页面内容</h4>

<p>根据前面的分析，只需要更改网页链接中的 <code>offset</code> 参数就可以生成新的请求链接，为了提高封装性，这里将网页内容的获取过程定义为一个函数，参数为 <code>offset</code>，这里需要注意的是，为了防止被头条屏蔽IP或拒绝访问，这里还需要给出一定头信息，参考chrome检查窗口中看到的请求头的信息即可：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Host&#39;</span><span class="p">:</span> <span class="s1">&#39;www.toutiao.com&#39;</span><span class="p">,</span>
    <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1 Safari/605.1.15&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X-Requested-With&#39;</span><span class="p">:</span> <span class="s1">&#39;XMLHttpRequest&#39;</span>
<span class="p">}</span></code></pre></div>
<p>请求链接中的参数使用<code>urlencode</code>方法进行封装处理，根据链接特征需要指定参数如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="s1">&#39;狗狗&#39;</span><span class="p">,</span>
    <span class="s1">&#39;autoload&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cur_tab&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;gallery&#39;</span>
<span class="p">}</span></code></pre></div>
<p>为了提高程序的鲁棒性，使用try-except处理异常，最终实现的函数如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_page_json</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;生成ajax请求，发出get请求，并获取响应结果，以字典的形式返回json数据
</span><span class="s1">    :params offset: 页面请求偏移值
</span><span class="s1">    :type offset: 能被20整除的整数
</span><span class="s1">    :return: 响应数据
</span><span class="s1">    :rtype: dict
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="s1">&#39;狗狗&#39;</span><span class="p">,</span>
        <span class="s1">&#39;autoload&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cur_tab&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;gallery&#39;</span>
    <span class="p">}</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.toutiao.com/search_content/?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code></pre></div>
<p>使用get方法进行请求，如果正常的话，就会得到响应的json数据，最终函数返回json数据转换成的字典数据，如果出现异常就会返回<code>None</code>。</p>

<h4 id="解析响应结果">解析响应结果</h4>

<p>上一步获得了一次请求的json数据，下面就该实现响应结果的解析了，因为得到的是字典，所以首先得到<code>data</code>键对应的值，是一个列表，对应包含20个条目的数据，遍历列表中的元素，每个元素都是字典，找到<code>title</code>键对应的值就是标题，<code>image_list</code>键对应的值是一个列表，列表中的元素就是链接关键信息，为链接信息加上协议组成正常的url字符串即可，将解析出来的每个链接和上层的标题共同组成一个字典返回，这里用<code>yield</code>方法生成迭代器，最终实现的函数如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">parse_images_url</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;解析json字典，获得对应条目标题和图片链接
</span><span class="s1">    :param json: 页面请求响应结果对应的字典数据
</span><span class="s1">    :type json: dict
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;image_list&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">images</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">{</span>
                        <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="s1">&#39;http:&#39;</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span>
                    <span class="p">}</span></code></pre></div>
<h4 id="下载图片">下载图片</h4>

<p>得到了图片链接，那么我们就可以保存图片了，同样将保存图片的操作封装为一个函数。</p>

<p>思路很简单，为了更好的管理图片，生成以标题命名的目录用来保存图片，get请求图片链接，因为获取的是二进制数据，所以将响应结果按照二进制保存为文件，文件名则根据二进制数据计算md5生成文件名，实现中加入了多个信息判断以及try-except方式的处理，最终结果如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">save_image_from</span><span class="p">(</span><span class="n">image_info</span><span class="p">,</span> <span class="n">to_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;根据链接获取图片，保存到标题命名的目录中，图片以md5码命名
</span><span class="s1">    :param image_info: 包含标题和链接信息的字典数据
</span><span class="s1">    :type image_info: dict
</span><span class="s1">    :param to_dir: 要保存到的目录，默认值是空字符串，可指定目录，格式如: &#39;狗狗&#39;
</span><span class="s1">    :type to_dir: unicode 字符串
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">image_info</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">image_info</span><span class="p">)</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">to_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_info</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_info</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="s1">&#39;{0}/{1}.{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">md5</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="s1">&#39;jpg&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;图片下载完成！&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;图片已下载 -&gt; &#39;</span><span class="p">,</span> <span class="n">image_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;图片下载失败！&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;出现异常！&#39;</span><span class="p">)</span></code></pre></div>
<p>可以看到函数还多了一个参数<code>to_dir</code>，这个参数用来指定目录，用来保存以标题命名的目录以及其目录下的图片。</p>

<h4 id="编写主函数实现">编写主函数实现</h4>

<p>每一次请求会收到20个条目的数据，这里我们以请求10次为例，也就是总共获取200个条目下的图片，实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 请求数</span>
<span class="n">PAGE_NUM</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="mi">20</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_NUM</span><span class="p">)]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;获取第&#39;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;～&#39;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;个条目...&#39;</span><span class="p">)</span>
        <span class="n">json</span> <span class="o">=</span> <span class="n">get_page_json</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">parse_images_url</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
            <span class="n">save_image_from</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">to_dir</span><span class="o">=</span><span class="s1">&#39;狗狗&#39;</span><span class="p">)</span></code></pre></div>
<h4 id="整合实现">整合实现</h4>

<p>将上述几部分的说明和实现进行整合：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/local/bin/python3</span>
<span class="c1"># 确认上面的python3路径是否正确</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">PAGE_NUM</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.1 Safari/605.1.15&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X-Requested-With&#39;</span><span class="p">:</span> <span class="s1">&#39;XMLHttpRequest&#39;</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_page_json</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
    <span class="c1"># 此处省略，参考前面的实现</span>

<span class="k">def</span> <span class="nf">parse_images_url</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
    <span class="c1"># 此处省略，参考前面的实现</span>

<span class="k">def</span> <span class="nf">save_image_from</span><span class="p">(</span><span class="n">image_info</span><span class="p">,</span> <span class="n">to_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="c1"># 此处省略，参考前面的实现</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 此处省略，参考前面的实现</span></code></pre></div>
<h2 id="测试及优化">测试及优化</h2>

<p>上述代码在脚本文件<code>toutiao_pic.py</code>中实现，执行脚本测试一下：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ python3 toutiao_pic.py
获取第 <span class="m">1</span> ～ <span class="m">20</span> 个条目...
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p3.pstatp.com/list/pgc-image/15296042422187b4c0bfb38&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;史上最美的11对狗狗的结婚照，一张你都没见过！&#39;</span><span class="o">}</span>
狗狗/史上最美的11对狗狗的结婚照，一张你都没见过！/f56a49c55933be46f87f554d961841a9.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p3.pstatp.com/list/pgc-image/152960424260924673d65ea&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;史上最美的11对狗狗的结婚照，一张你都没见过！&#39;</span><span class="o">}</span>
狗狗/史上最美的11对狗狗的结婚照，一张你都没见过！/ca6973e7d891a48ade41477ef3944627.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p3.pstatp.com/list/pgc-image/15296042427877f2cd0e93a&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;史上最美的11对狗狗的结婚照，一张你都没见过！&#39;</span><span class="o">}</span>
狗狗/史上最美的11对狗狗的结婚照，一张你都没见过！/5317c8b27494c21f8e05936fd092c580.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p3.pstatp.com/list/pgc-image/1529604243143d15de20946&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;史上最美的11对狗狗的结婚照，一张你都没见过！&#39;</span><span class="o">}</span>
狗狗/史上最美的11对狗狗的结婚照，一张你都没见过！/d83f8de993ccba427d62138812cbc9bf.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p1.pstatp.com/list/pgc-image/1529588142869caebf0b30d&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;儿子打了狗狗一下，接下来让一家人感动&#39;</span><span class="o">}</span>
狗狗/儿子打了狗狗一下，接下来让一家人感动/c1f1880a9dff12cadeb5893715b7b5de.jpg
图片下载完成！
.
.
.
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p1.pstatp.com/list/pgc-image/15268265312399549e4d5fe&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;可爱的狗狗&#39;</span><span class="o">}</span>
狗狗/可爱的狗狗/808e74f76dea32fd56614b82c2d55b79.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p3.pstatp.com/list/pgc-image/1526826535155011a163e03&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;可爱的狗狗&#39;</span><span class="o">}</span>
狗狗/可爱的狗狗/df7a97475a5b62ad4f0545fbf64f91ed.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p1.pstatp.com/list/pgc-image/15268265365385bfb3779ae&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;可爱的狗狗&#39;</span><span class="o">}</span>
狗狗/可爱的狗狗/7e9ae7183132420a1a49b8f14032f7f9.jpg
图片下载完成！
<span class="o">{</span><span class="s1">&#39;image&#39;</span>: <span class="s1">&#39;http://p3.pstatp.com/list/pgc-image/15268265382025a24d029a8&#39;</span>, <span class="s1">&#39;title&#39;</span>: <span class="s1">&#39;可爱的狗狗&#39;</span><span class="o">}</span>
狗狗/可爱的狗狗/8fa9fe7c4096e6b5026767f7cca9400e.jpg
图片下载完成！
获取第 <span class="m">181</span> ～ <span class="m">200</span> 个条目...</code></pre></div>
<p>顺利的话，查看脚本同级目录中出现了<code>狗狗</code> 的目录，检查目录中确实按照预期爬取了图片。</p>

<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/20180622152964907254058.png" alt="20180622152964907254058.png" /></p>

<h3 id="结果分析">结果分析</h3>

<p>针对成果，总结分析有三点需要改进的地方：
1. 图片分辨率低：查看图片，你会发现分辨率很低，有的几乎看不清；
2. 没有使用多进程爬取；
3. 脚本不够通用，能不能像命令一样执行，实现可以搜索任意想搜索的图片，而不仅仅局限于🐶；</p>

<h3 id="优化">优化</h3>

<h4 id="图片分辨率问题">图片分辨率问题</h4>

<p>还是得分析网页，找到狗狗图集的页面，以第一个条目的第一个图片为例，看看有什么规律可循。</p>

<p>记录json数据中第一个图片的链接为：</p>

<p><a href="http://p1.pstatp.com/list/pgc-image/15296042422187b4c0bfb38" target="_blank">http://p1.pstatp.com/list/pgc-image/15296042422187b4c0bfb38</a></p>

<p>点击第一个条目，进入相应图集，还是看第一个图，这是发现图片分辨率明显提高，那么此时这个图片的链接是什么，查看一下为：</p>

<p><a href="http://p3.pstatp.com/origin/pgc-image/15296042422187b4c0bfb38" target="_blank">http://p3.pstatp.com/origin/pgc-image/15296042422187b4c0bfb38</a></p>

<p>比较两个链接，发现有两个不同的地方：</p>

<table>
<thead>
<tr>
<th align="center">图片链接</th>
<th align="center">主机名</th>
<th align="center">目录名</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">低分辨率</td>
<td align="center">p1</td>
<td align="center">list</td>
</tr>

<tr>
<td align="center">高分辨率</td>
<td align="center">p3</td>
<td align="center">origin</td>
</tr>
</tbody>
</table>

<p>更改低分辨率图片链接中的<code>p1</code>为<code>p3</code>，用浏览器去访问，居然也能出图片，但还是低分辨率，看来这个不关键，那只更改<code>list</code>为<code>origin</code>试一下，居然可以访问，而且是高分辨率的图片。</p>

<p>以此方式比较几张其它图片的链接，发现均可以只改链接中的<code>list</code>为<code>origin</code>就能得到高分辨率的图片，那么优化函数<code>parse_images_url</code>中的image链接生成的那一行代码，调用字符串替换函数<code>replace</code>就可以，如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 原代码</span>
<span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="s1">&#39;http:&#39;</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
<span class="c1"># 改进后代码</span>
<span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="s1">&#39;http:&#39;</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">),</span></code></pre></div>
<p>重新运行脚本，检查图片，结果可行！</p>

<h4 id="多进程爬取">多进程爬取</h4>

<p>这里采用多进程库<code>multiprocessing</code>的进程池实现多进程调度，为了方便映射，将主函数中的实现，封装为main函数，参数用来进程分配，所以为<code>offset</code>，<code>main</code>函数实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;主函数，用于多进程调度
</span><span class="s1">    :param offset: 页面链接offset参数的值
</span><span class="s1">    :type offset: 能被20整除的整数
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;获取第&#39;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;～&#39;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;个条目...&#39;</span><span class="p">)</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">get_page_json</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">parse_images_url</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
        <span class="n">save_image_from</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">to_dir</span><span class="o">=</span><span class="s1">&#39;狗狗&#39;</span><span class="p">)</span></code></pre></div>
<p>引入多进程库：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">Pool</span></code></pre></div>
<p>生成进程池，映射主函数并执行，最终实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">offset_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="mi">20</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_NUM</span><span class="p">)]</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">offset_list</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></code></pre></div>
<p>执行后，看打印信息，会发现会有多个请求同时进行，速度明显加快。</p>

<h4 id="通用化脚本">通用化脚本</h4>

<p>这里说通用化，也仅局限于获取头条中的图集，目前根据前面分析，链接中可以更改的除了<code>offset</code>，其实还有个<code>keyword</code>，其它的目前来看没必要更改了，说起来其中<code>count</code>应该也可以修改，这里有个假设：</p>

<ul>
<li><code>offset</code>与<code>count</code>有关，<code>offset</code>值要能被<code>count</code>整除；</li>
<li>响应结果中条目数与<code>count</code>对应</li>
</ul>

<blockquote>
<p>上面的假设就不验证了，留给感兴趣的人吧，这里只做<code>offset</code>和<code>keyword</code>的定制实现。</p>
</blockquote>

<p>稍微修改<code>get_page_json</code>函数和<code>main</code>函数，加入keyword参数用来指定搜索关键词：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_page_json</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;生成ajax请求，发出get请求，并获取响应结果，以字典的形式返回json数据
</span><span class="s1">    :param offset: 页面请求偏移值
</span><span class="s1">    :type offset: 能被20整除的整数
</span><span class="s1">    :param keyword: 图片搜索的关键词
</span><span class="s1">    :type keyword: unicode字符串
</span><span class="s1">    :return: 响应数据
</span><span class="s1">    :rtype: dict
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="n">keyword</span><span class="p">,</span>
        <span class="s1">&#39;autoload&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cur_tab&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;gallery&#39;</span>
    <span class="p">}</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.toutiao.com/search_content/?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;主函数，用于多进程调度
</span><span class="s1">    :param offset: 页面链接offset参数的值
</span><span class="s1">    :type offset: 能被20整除的整数
</span><span class="s1">    :param keyword: 图片搜索关键词
</span><span class="s1">    :type keyword: unicode字符串
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;获取第&#39;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;～&#39;</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;个条目...&#39;</span><span class="p">)</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">get_page_json</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">parse_images_url</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
        <span class="n">save_image_from</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">to_dir</span><span class="o">=</span><span class="n">keyword</span><span class="p">)</span></code></pre></div>
<p>能不能做成类似于命令行的方式传入搜索的关键词呢？当然可以了，首先在脚本文档最前面加上如下的代码，用来指明所使用的python路径，例如<a href="https://www.smslit.top/about" target="_blank">十里</a>的是：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/local/bin/python3</span></code></pre></div>
<p>然后为脚本文件加上执行权限：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ chmod +x toutiao_pic.py</code></pre></div>
<p>这样你就可以像命令一样执行脚本了：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ ./toutiao_pic.py</code></pre></div>
<p>这里实现一个简单的参数设置思路，规定必须输入两个参数，一个是关键词，一个是请求个数，所以固定命令的格式为：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">./toutiao_pic.py 狗狗 <span class="m">5</span></code></pre></div>
<p>即命令后跟着第一个参数就是图片搜索的关键词，然后就是请求个数的设置，如果要提取这两个参数，需要用到<code>sys</code>库的<code>argv</code>，在脚本中<code>sys.argv</code>是一个字符串列表，第一个元素就是命令，在这里的话，如果输入命令格式正确，那么这个列表会包含三个元素，后两个按顺序分别是：图片搜索关键词和请求个数（每个请求会得到20个图集信息），为了更好的交互，还得加入一定的帮助信息的打印，所以最终添加了以下代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_help_info</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;生成帮助信息
</span><span class="s1">    :param command: 命令的名称
</span><span class="s1">    :type command: 字符串
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">help_info</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">使用:</span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">+</span> <span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; 关键字 请求个数</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">help_info</span> <span class="o">+=</span> <span class="s1">&#39;  - 关键字: 图片搜索关键词</span><span class="se">\n</span><span class="s1">  - 请求个数: 一次请求会获取20个图集的图片</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">help_info</span> <span class="o">+=</span> <span class="s1">&#39;例如:</span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">+</span> <span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; 狗狗 5</span><span class="se">\n</span><span class="s1">  -&gt; 会获取100个图集中狗狗的图片</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">help_info</span>

<span class="k">def</span> <span class="nf">parse_argv</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;解析命令参数
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">args_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;-h&#39;</span><span class="p">:</span> <span class="n">get_help_info</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;-k&#39;</span><span class="p">:</span> <span class="s1">&#39;狗狗&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-n&#39;</span><span class="p">:</span> <span class="n">PAGE_NUM</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;-h&#39;</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;-n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_num</span> <span class="k">if</span> <span class="n">page_num</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="k">else</span> <span class="mi">5</span>
            <span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;-k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;请求个数有误，请输入整数&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args_dict</span></code></pre></div>
<p>此时会有一个问题，那就是main函成为了有两个参数函数，进程池map的处理需要调整。先看一下现在程序的执行思路：先解析命令参数获得关键词和请求个数，然后传入main函数进行处理。进程池的map只能管理单个参数的函数，那么现在的问题就是解决进程池的map的多参数处理，应该有多个方法，可以发现main函数执行的话每次传入的图片搜索关键词是一定的，那么可以利用<code>functools</code>库的<code>partial</code>类构造一个只有<code>offset</code>这个参数的partial函数，实现过程：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">args_dict</span> <span class="o">=</span> <span class="n">parse_argv</span><span class="p">()</span>
    <span class="n">offset_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="mi">20</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;-n&#39;</span><span class="p">])]</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
    <span class="n">partial_main</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;-k&#39;</span><span class="p">])</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">partial_main</span><span class="p">,</span> <span class="n">offset_list</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></code></pre></div>
<h2 id="总结">总结</h2>

<p>至此，所有代码已经完成，为了让脚本用起来更像命令行工具，可以把后缀名<code>py</code>去掉，然后想一个好名字重命名一下，比如这样：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ mv toutiao_pic.py ttpic
$ ./ttpic

使用:
  ./ttpic 关键字 请求个数
  - 关键字: 图片搜索关键词
  - 请求个数: 一次请求会获取20个图集的图片
例如:
  ./ttpic 狗狗 <span class="m">5</span>
  -&gt; 会获取100个图集中狗狗的图片</code></pre></div>
<p>如果我们想要爬取<code>猫咪</code>的图片，另外想要获取100个图集的，请求个数设置为 $100\div20=5$ ，最终命令为：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ ./ttpic 猫咪 <span class="m">5</span></code></pre></div>
<p>完整代码可参考: <a href="https://github.com/smslit/spider-collection/blob/master/ttpic/ttpic" target="_blank">ttpic</a></p>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.smslit.top/tags/python">python</a></span><span class="tag"><a href="https://www.smslit.top/tags/spider">spider</a></span>
				</p>
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
					6591 字
				</p>
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
					2018-06-21 14:41 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">目录</div>
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#网页分析">网页分析</a>
<ul>
<li><a href="#响应结果分析">响应结果分析</a></li>
<li><a href="#请求头分析">请求头分析</a></li>
</ul></li>
<li><a href="#爬虫实现">爬虫实现</a>
<ul>
<li><a href="#爬虫思路">爬虫思路</a></li>
<li><a href="#库的选择">库的选择</a></li>
<li><a href="#爬虫实现-1">爬虫实现</a>
<ul>
<li><a href="#请求页面内容">请求页面内容</a></li>
<li><a href="#解析响应结果">解析响应结果</a></li>
<li><a href="#下载图片">下载图片</a></li>
<li><a href="#编写主函数实现">编写主函数实现</a></li>
<li><a href="#整合实现">整合实现</a></li>
</ul></li>
</ul></li>
<li><a href="#测试及优化">测试及优化</a>
<ul>
<li><a href="#结果分析">结果分析</a></li>
<li><a href="#优化">优化</a>
<ul>
<li><a href="#图片分辨率问题">图片分辨率问题</a></li>
<li><a href="#多进程爬取">多进程爬取</a></li>
<li><a href="#通用化脚本">通用化脚本</a></li>
</ul></li>
</ul></li>
<li><a href="#总结">总结</a></li>
</ul></li>
</ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.smslit.top/2018/06/23/spider-basic-pyquery/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;下一篇</span><br><span>爬虫基础之pyquery</span>
			</a>
			<a class="prev-post" href="https://www.smslit.top/2018/03/06/sketch-practice3/">
				<span class="post-nav-label">上一篇&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>sketch练习稿第三波——我们</span>
			</a>
		</div>
		<div id="comments" class="thin">
		<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">打赏作者</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/assets/pay/wechatpay.png">
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/assets/pay/alipay.png">
      </label>
  </div>
</div>


<span id="/2018/06/21/spider-practice-pic-dog/" class="leancloud_visitors" data-flag-title="爬虫实践之头条狗狗图片">
  <span class="post-meta-item-text">访问量 </span>
  <span class="leancloud-visitors-count"></span>
  <p></p>
</span>
<div id="vcomments"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script type="text/javascript">
  new Valine({
      el: '#vcomments' ,
      appId: 'IlJ4XQsE83q10RN3Maoglx2x-gzGzoHsz',
      appKey: 'OxVuAMUYBTbDMO9vO2IqTsMR',
      notify:  false , 
      verify:  false , 
      avatar:'', 
      placeholder: '说点什么吧...(提醒：填写邮箱，若有人回复您，您将及时收到提醒邮件！)',
      visitor:  true 
  });
</script>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://www.smslit.top">5km</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.smslit.top/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.smslit.top/js/main.min.8f39f24808e9d0a9b02da58c2d2838da859dc0b7bdfadbdb1883aae8b6adacfe.js" integrity="sha256-jznySAjp0KmwLaWMLSg42oWdwLe9+tvbGIOq6LatrP4="></script>

	
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: {equationNumbers: {autoNumber: "AMS"}},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>

</html>
