<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c"><meta itemprop="name" content="图中藏(cáng)语">
<meta itemprop="description" content="今天分享一个好玩工具，这个工具可以往图片中藏入信息，当然也可以从藏有信息的图片中将信息找出来。专业名词的话，这叫图片隐写技术，但无所谓了，我们知道是咋回事儿就好。本文将介绍如何使用 python3 实现这个工具。
">
<meta itemprop="datePublished" content="2018-10-20T10:09:31+08:00" />
<meta itemprop="dateModified" content="2018-10-20T10:09:31+08:00" />
<meta itemprop="wordCount" content="4771">



<meta itemprop="keywords" content="hacker,python,life," />
<meta property="og:title" content="图中藏(cáng)语" />
<meta property="og:description" content="今天分享一个好玩工具，这个工具可以往图片中藏入信息，当然也可以从藏有信息的图片中将信息找出来。专业名词的话，这叫图片隐写技术，但无所谓了，我们知道是咋回事儿就好。本文将介绍如何使用 python3 实现这个工具。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.smslit.top/2018/10/20/codeimg-python/" />
<meta property="article:published_time" content="2018-10-20T10:09:31+08:00" />
<meta property="article:modified_time" content="2018-10-20T10:09:31+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="图中藏(cáng)语"/>
<meta name="twitter:description" content="今天分享一个好玩工具，这个工具可以往图片中藏入信息，当然也可以从藏有信息的图片中将信息找出来。专业名词的话，这叫图片隐写技术，但无所谓了，我们知道是咋回事儿就好。本文将介绍如何使用 python3 实现这个工具。
"/>
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>图中藏(cáng)语</title>
	<link rel="stylesheet" href="https://www.smslit.top/css/style.min.ab9864138f55418230bf7a097d82dade6867ae1044d6e9fb1b8788f54e8fa7a5.css" integrity="sha256-q5hkE49VQYIwv3oJfYLa3mhnrhBE1un7G4eI9U6Pp6U=">
	
	<link rel="stylesheet" href="https://www.smslit.top/css/valine.css">
	<link rel="stylesheet" href="https://www.smslit.top/css/reward.css">
	<link rel="stylesheet" href="https://www.smslit.top/css/asciinema.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.smslit.top">SMSLIT</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://www.smslit.top/post/">Posts</a>
				<a href="https://www.smslit.top/tags/">Tags</a>
				<a href="https://www.smslit.top/about/">Me</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="目录"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="http://weibo.com/u/2684217817" target="_blank" rel="noopener me" title="Weibo"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg"  fill="none" fill-rule="evenodd" class="feather feather-mail">
    <g transform="translate(0.000000, 2.000000)" fill="#000000" fill-rule="nonzero" id="形状">
        <path d="M23.7,8.59152679 C23.6,8.94964029 23.25,9.20543566 22.9,9.25659472 C22.55,9.30775379 22.2,9.10311751 22,8.745004 C21.9,8.54036772 21.85,8.28457235 21.95,8.02877698 C22.45,6.44284573 22.1,4.70343724 21,3.4756195 C19.9,2.24780175 18.3,1.68505194 16.7,2.04316547 C16.45,2.09432453 16.2,2.04316547 16,1.88968825 C15.8,1.73621103 15.65,1.53157475 15.6,1.27577938 C15.5,0.764188657 15.8,0.252597914 16.3,0.150279784 C18.45,-0.310151871 20.75,0.354916067 22.35,2.14548362 C23.95,3.98721024 24.35,6.44284573 23.7,8.59152679 Z M17.35,5.06155077 C17.15,5.11270983 16.95,5.06155077 16.75,4.95923261 C16.55,4.85691446 16.45,4.65227818 16.4,4.44764189 C16.3,3.98721024 16.6,3.57793765 17,3.4756195 C18.1,3.21982412 19.2,3.62909671 19.95,4.44764189 C20.7,5.31734614 20.9,6.4940048 20.6,7.56834532 C20.55,7.77298161 20.4,7.92645882 20.2,8.02877698 C20,8.13109513 19.8,8.13109513 19.6,8.07993604 C19.2,7.92645882 18.95,7.46602717 19.1,7.0567546 C19.25,6.54516388 19.15,5.93125501 18.8,5.52198242 C18.4,5.11270983 17.85,4.95923261 17.35,5.06155077 Z M18.05,9.66586731 C19.45,10.126299 20.95,11.1494804 20.95,13.0423661 C20.95,16.1119105 16.6,20 10.1,20 C5.1,20 1.13686838e-13,17.5443645 1.13686838e-13,13.4516387 C1.13686838e-13,11.3029576 1.30000001,8.84732213 3.6,6.54516386 C6.6,3.42446043 10.15,2.04316547 11.45,3.37330137 C12.05,3.98721024 12.1,5.0103917 11.7,6.23820942 C11.5,6.8521183 12.25,6.4940048 12.25,6.4940048 C14.7,5.41966427 16.85,5.3685052 17.6,6.54516386 C18,7.15907273 17.95,8.02877698 17.6,9.00079935 C17.45,9.46123101 17.7,9.56354916 18.05,9.66586731 Z M10.1,18.5163869 C14.05,18.1071143 17.1,15.6003197 16.85,12.940048 C16.6,10.2797762 13.15,8.43804957 9.19999999,8.84732213 C5.25,9.25659472 2.19999998,11.7633893 2.44999999,14.4236611 C2.7,17.0839329 6.09999998,18.9256595 10.1,18.5163869 Z M10.5,10.8936851 C12.45,11.4052758 13.45,13.2981615 12.65,15.1398881 C11.85,17.0327738 9.49999999,18.0047962 7.54999999,17.3908873 C5.64999998,16.7769784 4.84999999,14.8329336 5.65000001,13.0935252 C6.45,11.3541167 8.60000002,10.3820943 10.5,10.8936851 Z M9.04999999,15.3445244 C9.45,14.7306155 9.24999998,13.9632294 8.59999999,13.7074341 C7.99999999,13.4516387 7.2,13.7074341 6.79999999,14.3213429 C6.39999998,14.9352518 6.6,15.6514788 7.2,15.9584333 C7.84999999,16.2653877 8.65000001,16.0095923 9.04999999,15.3445244 Z" fill="currentColor"></path>
    </g>
</svg></a><a href="https://www.zhihu.com/people/smslit/activities" target="_blank" rel="noopener me" title="Zhihu"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="none" fill-rule="evenodd" class="feather feather-mail">
    <path d="M12.1197571,11.3394973 C11.2394396,11.2471275 8.50587146,11.3394973 8.50587146,11.3394973 L8.50587146,5.8004836 L12.5830381,5.8004836 C12.5830381,5.8004836 12.5367176,3.95412048 11.7490411,3.95412048 L5.12356308,3.95412048 L6.23550841,1 C6.23550841,1 4.56753979,1.09236985 3.96524661,2.15395489 C3.36295344,3.21553992 1.46333165,8.52386857 1.46333165,8.52386857 C1.46333165,8.52386857 2.11199596,8.80082682 3.17759547,8.0161496 C4.2432456,7.2314976 4.6138603,5.84665591 4.6138603,5.84665591 L6.5598026,5.75428606 L6.60612311,11.3856444 C6.60612311,11.3856444 3.22394129,11.3394973 2.52895647,11.3856444 C1.83397166,11.4317915 1.46330634,13.2781799 1.46330634,13.2781799 L6.60619904,13.2781799 C6.60619904,13.2781799 6.14281677,16.4169392 4.8455894,18.6787523 C3.50191497,20.9405149 1,22.7406553 1,22.7406553 C1,22.7406553 2.80693015,23.4791854 4.56761573,22.4636971 C6.32822537,21.4020364 7.62555398,16.8323387 7.62555398,16.8323387 L11.7491424,21.9559781 C11.7491424,21.9559781 12.1197824,19.5096018 11.7028219,18.8172188 C11.2394396,18.1248358 8.83019096,15.3553541 8.83019096,15.3553541 L7.76454082,16.2784726 L8.50584615,13.2319823 L12.9999986,13.2319823 C13.0000745,13.2320328 13.0000745,11.4318672 12.1197571,11.3394973 Z M14.0447646,4 L14,20.8940959 L15.6119399,20.8940959 L16.1940015,23 L19.014927,20.8940959 L23,20.8940959 L23,4 L14.0448624,4 L14.0447646,4 Z M21,18.2118088 L19.2203194,18.2118088 L16.9745545,20 L16.4660842,18.2118088 L16,18.2118088 L16,6 L21,6 L21,18.2118088 Z" id="形状" fill="currentColor" fill-rule="nonzero"></path>    
</svg></a><a href="mailto:5km@smslit.cn" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="https://github.com/smslit" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="菜单"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.smslit.top/post/">Posts</a></li>
			<li><a href="https://www.smslit.top/tags/">Tags</a></li>
			<li><a href="https://www.smslit.top/about/">Me</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Oct 20, 2018</span></div>
				<h1>图中藏(cáng)语</h1>
			</header>
			<div class="content">
				<p>今天分享一个好玩工具，这个工具可以往图片中藏入信息，当然也可以从藏有信息的图片中将信息找出来。专业名词的话，这叫图片隐写技术，但无所谓了，我们知道是咋回事儿就好。本文将介绍如何使用 python3 实现这个工具。</p>
<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/20181020154000344643954.png" alt="20181020154000344643954.png"></p>
<h1 id="原理">原理</h1>
<p>在实现工具之前，先了解一下原理。</p>
<h2 id="隐写术">隐写术</h2>
<blockquote>
<p>隐写术是一门关于信息隐藏的技巧与科学，所谓信息隐藏指的是不让除预期的接收者之外的任何人知晓信息的传递事件或者信息的内容。</p>
</blockquote>
<blockquote>
<p>—— <a href="https://zh.wikipedia.org/wiki/%E9%9A%90%E5%86%99%E6%9C%AF">隐写术</a> <a href="https://zh.wikipedia.org/wiki/Wikipedia:%E9%A6%96%E9%A1%B5">@维基百科</a></p>
</blockquote>
<p>可以类比一下无线电，无线电传递信息的原理可以简单地理解为：发射端在载波上注入高频信号，而接收端收到信号后解析载波上的高频信号，从而实现信息的无线传输，其中载波的波长远大于载入信号的波长。同理图片隐写术中图片就是信息载体文件，载体文件（cover file）相对隐秘文件的大小（指数据含量，以比特计）越大，隐藏后者就越加容易。</p>
<h2 id="数据存储">数据存储</h2>
<p>这里选择位图图片作为载体，一张8位RGB的 JPG 位图中的一个像素包含 R、G、B 三个通道的数值，每个通道数值为8位数据，也就是 <code>0b00000000</code>～<code>0b11111111</code> 的数值，想象一下其中一个通道，就以 R 通道来讲，<code>0b11101111</code> 和 <code>0b11101110</code> 只是最低位不一样，实际图片的表现上，这种差别肉眼几乎是无法察觉的，所以可以利用每个通道的最低位来存储 1bit 的数据是可行的^[更正式一点地说，使隐写的信息难以探测的，也就是保证“有效载荷”（需要被隐蔽的信号）对“载体”（即原始的信号）的调制对载体的影响看起来（理想状况下甚至在统计上）可以忽略。这就是说，这种改变应该无法与载体中的噪声加以区别。从信息论的观点来看，这就是说信道的容量必须大于传输“表面上”的信号的需求。这就叫做信道的冗余。「来自<a href="https://zh.wikipedia.org/wiki/%E9%9A%90%E5%86%99%E6%9C%AF"><strong>隐写术</strong></a>」]。</p>
<p><img src="https://pichome-1254392422.cos.ap-chengdu.myqcloud.com/20181020154001752117286.png" alt="20181020154001752117286.png"></p>
<p>如此的话每个像素三个通道共可以存储 3 bits，那如果像 png 图片一样再多一个 Alpha 通道（透明通道），就可以存储 4 bits，两个像素就可以存储一个字节，方便处理。另外注意的是，我们这里存储和读取字节数据均采用 <a href="https://baike.baidu.com/item/Little-Endian/4118225?fr=aladdin"><strong>Little-Endian</strong></a>方式^[（小字节序、低字节序）,即低位字节排放在内存的低地址端，高位字节排放在内存的高地址端。 与之对应的是：<strong>BIG-ENDIAN</strong>（大字节序、高字节序）]，后面写程序的时候要清楚！</p>
<h1 id="实现">实现</h1>
<p>在 <code>messageimage.py</code> 文件中为图片处理实现一个类 <code>MessageImage</code> ，然后编写一个 python 脚本命令行工具，保存为文件 <code>codeimg</code>。</p>
<h2 id="messageimage-类"><strong>MessageImage</strong> 类</h2>
<p>本文实现的类中，涉及了 <strong>pillow</strong> 库的使用，字符串的编码转换等知识。</p>
<h3 id="问题分析">问题分析</h3>
<p>小节 <a href="#数据存储">原理-数据存储</a> 中介绍了隐写信息在图片中的存储方式，数据写入和读取要参考这个原理，但是这里还需要考虑两个问题，针对这两个问题，分别提出解决方法，剩下的就是代码实现的问题了。</p>
<h4 id="图片没有alpha通道问题">图片没有alpha通道问题</h4>
<p>对于不含透明通道的位图图片（比如jpg）来说，少一个 Alpha 通道，那么 <a href="#数据存储">原理-数据存储</a> 提到的四通道存储方案显然缺少通道，其实解决很简单，只需要使用 <strong>pillow</strong> 库将 jpg 图片数据转换为带 alpha 通道的数据即可进行，可使用如下的方法转换：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;demo.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">)</span>
</code></pre></div><p>直接转换为 RGBA 模式即可。</p>
<h4 id="怎么判断图片有没有隐写信息问题">怎么判断图片有没有隐写信息问题</h4>
<p>为了判断图片有没有隐写信息，这里设计一个字节数据包存储协议，协议很简单，如下表：</p>
<table>
<thead>
<tr>
<th>head</th>
<th>length</th>
<th>data</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x5555AAAA</td>
<td>数据长度</td>
<td>数据</td>
</tr>
<tr>
<td>占 4 字节</td>
<td>占 4 字节</td>
<td>占 length 字节</td>
</tr>
</tbody>
</table>
<p>最开始的4个字节为标记，再之后的四字节表示图片中信息的字节数目，之后则是 length 个字节的主要数据。所以判断有没有隐写信息的流程应该是：</p>
<ol>
<li>从图片中前16个像素数据中，解析出8个字节；</li>
<li>判断前4个字节与预设的 head 是不是一致，如果一致则说明有隐写信息；</li>
</ol>
<p>当然，head 是可以任意定义的，通过此方法，判断有没有隐写信息出错的概率为：</p>
<p>$$
p = \frac{1}{2^{32}} = 0.000000000232831
$$</p>
<h3 id="准备工作">准备工作</h3>
<ol>
<li>
<p>这里使用的第三方库是图片处理库 <strong>pillow</strong>，安装很简单：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ pip3 install pillow
</code></pre></div></li>
<li>
<p>新建文件 <code>messageimage.py</code></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ touch messageimage
</code></pre></div></li>
<li>
<p>导入需要的库，向文件 <code>messageimage.py</code> 中添加以下内容</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</code></pre></div></li>
<li>
<p>声明类 MessageImage，文件 <code>messageimage.py</code> 中添加:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">MessageImage</span><span class="p">:</span>
    <span class="s2">&#34;&#34;&#34; MessageImage 类
</span><span class="s2">    初始化加载图片或者手动打开图片，将隐写信息写入图片，也可以解析图片中的隐写信息
</span><span class="s2">    Attributes:
</span><span class="s2">        image: 打开图片的 Image 类型对象
</span><span class="s2">        pkghead: 写入图片隐写信息的头标记，可以初始化时赋值
</span><span class="s2">    &#34;&#34;&#34;</span>
</code></pre></div><p>剩下的就是添加类的方法了。</p>
</li>
</ol>
<h3 id="公共方法实现">公共方法实现</h3>
<p>为类实现下面几个公共方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
<th>参数</th>
<th>返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__init__(self, imgpath, pkghead=None)</code></td>
<td>初始化类，生成 MessageImage 实例</td>
<td><strong>imgpath</strong>：图片路径；<strong>pkghead</strong>：自定义协议头</td>
<td>无</td>
</tr>
<tr>
<td><code>encode(self, info, save=True, show=False)</code></td>
<td>将指定的隐写信息写入图片</td>
<td><strong>info</strong>：隐写信息（字符串）；<strong>save</strong>：控制是否将写入信息的图片进行保存(默认 <strong>True</strong>)；<strong>show</strong>：控制是否在写入信息后显示结果图片(默认 <strong>False</strong>)</td>
<td>写入成功就返回 <strong>True</strong>，失败返回 <strong>False</strong></td>
</tr>
<tr>
<td><code>decode(self)</code></td>
<td>解析图片中的隐写信息</td>
<td>无</td>
<td>如果解析成功，返回隐写信息，其它情况返回 <strong>None</strong></td>
</tr>
<tr>
<td><code>open(self, imgpath)</code></td>
<td>打开指定图片，转换数据为 RGBA 模式数据赋给属性 <strong>image</strong></td>
<td><strong>imgpath</strong>：图片路径</td>
<td>无</td>
</tr>
<tr>
<td><code>freespace(self)</code></td>
<td>计算图片中可用空间，单位 byte</td>
<td>无</td>
<td>返回可用空间大小，单位字节</td>
</tr>
<tr>
<td><code>sethead(self, pkghead)</code></td>
<td>设置协议头</td>
<td><strong>pkghead</strong>：自定义协议头</td>
<td>无</td>
</tr>
</tbody>
</table>
<h4 id="初始化">初始化</h4>
<p>类的初始化，主要是根据指定图片和指定存储协议头初始化基本属性：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgpath</span><span class="p">,</span> <span class="n">pkghead</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">imgpath</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imgpath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">pkghead</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkghead</span> <span class="o">=</span> <span class="n">pkghead</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkghead</span> <span class="o">=</span> <span class="mh">0x5555AAAA</span>
</code></pre></div><p>上述操作中用到了 <a href="#open方法"><strong>open</strong></a> 方法。</p>
<h4 id="encode方法">encode方法</h4>
<p>encode 方法的思路依赖于 <a href="#数据存储">原理-数据存储</a> 和 <a href="#问题分析">问题分析</a>，实现思路为：</p>
<ol>
<li>使用私有方法 <a href="#__pack">__pack</a> 打包指定的隐写信息，得到一个完整的协议报数据；</li>
<li><a href="#__putdata">__putdata</a> 将协议包数据写入图片数据，得到新的图片数据；</li>
</ol>
<p>实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;图片为空，请调用实例的 open 方法打开一张图片！&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">pkgbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pack</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__putdata</span><span class="p">(</span><span class="n">pkgbytes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgpath</span><span class="p">)</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">pathlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_code&#39;</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">newpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div><h5 id="__pack">__pack</h5>
<p>这个方法主要是按照 <a href="#怎么判断图片有没有隐写信息问题">怎么判断图片有没有隐写信息问题</a> 小节中提到的协议进行打包，具体实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    打包数据，转换为待写入图片的字节数据组，并返回
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">tagbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkghead</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
    <span class="n">databytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
    <span class="n">lengthbytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">databytes</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
    <span class="n">pkgbytes</span> <span class="o">=</span> <span class="n">tagbytes</span> <span class="o">+</span> <span class="n">lengthbytes</span> <span class="o">+</span> <span class="n">databytes</span>
    <span class="k">return</span> <span class="n">pkgbytes</span>
</code></pre></div><p>这里有两点关键：</p>
<ul>
<li>
<p>使用 <code>int</code> 的 <code>to_bytes</code> 方法，将整数转换成 4 字节数组^[<a href="https://www.delftstack.com/zh/howto/python/how-to-convert-int-to-bytes-in-python-2-and-python-3/">如何将整型int转换为字节bytes</a>]</p>
</li>
<li>
<p>使用 <code>utf8</code> 编码方式将指定隐写信息转换为字节数组^[<a href="https://blog.csdn.net/idealcitier/article/details/80007598">Python实现字符串与字节之间的相互转换</a>]</p>
</li>
</ul>
<h5 id="__putdata">__putdata</h5>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__putdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkgbytes</span><span class="p">):</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
    <span class="n">freespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freespace</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkgbytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">freespace</span><span class="p">:</span>  <span class="c1"># 超出全部数据空间， 抛出异常</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;错误: 不能载入超过 &#34;</span> <span class="o">+</span> <span class="n">freespace</span> <span class="o">+</span> <span class="s2">&#34; 字节的数据到图片中。&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">byte</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pkgbytes</span><span class="p">):</span>
        <span class="n">_index</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">index</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="n">_index</span><span class="p">])])</span>
        <span class="n">_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="n">_index</span><span class="p">])])</span>
    <span class="n">newimg</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">newimg</span><span class="o">.</span><span class="n">putdata</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">newimg</span>
</code></pre></div><p>简单说一下上面实现的过程：</p>
<ol>
<li>
<p>得到包含像素数据的列表，这个列表的元素是 <code>tuple</code>，<code>tuple</code> 包含的四个数据就是对应像素的 R、G、B、A 四个通道的数值；</p>
</li>
<li>
<p>为了处理待写入数据超过图片可存空间的情况，这里调用 <a href="#freespace方法">freespace</a> 获取可用空间与待写数据大小比较，如果超出就发起异常！</p>
</li>
<li>
<p>如果空间足够，就将隐写数据写入到像素数据中，这一部分实现在 <code>for</code> 循环中，枚举隐写数据中的字节，每个字节需要写入两个像素数据，低位在前原则，这里解释一下下面的语句：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">tuple</span><span class="p">([(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="n">_index</span><span class="p">])])</span>
<span class="nb">tuple</span><span class="p">([(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="n">_index</span><span class="p">])])</span>
</code></pre></div><ul>
<li><code>i</code> 和 <code>v</code> 分别是像素数据中通道数据的索引和值；</li>
<li><code>v &amp; 0xFE</code> ：将通道数据的最低位置0；</li>
<li><code>((byte &amp; 0x0F) &gt;&gt; i) &amp; 0x01</code> ：获取待写入字节低4位中的每一位数据，最终得到 0 或 1</li>
<li><code>((byte &gt;&gt; 4) &gt;&gt; i) &amp; 0x01</code> ：获取待写入字节高4位中的每一位数据，最终得到 0 或 1</li>
</ul>
</li>
<li>
<p>根据写入隐写信息图片数据创建新的图片对象赋值给属性 <code>image</code></p>
</li>
</ol>
<h4 id="decode方法">decode方法</h4>
<p>这个方法用来解析图片中的隐写信息，实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;图片为空，请调用实例的 open 方法打开一张图片！&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>        
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unpack</span><span class="p">()</span>
</code></pre></div><p>直接关键是调用了解包函数 <a href="#__unpack">__unpack</a>，返回的是它的结果。</p>
<h5 id="__unpack">__unpack</h5>
<p>用于从图片中检查是否包含隐写数据并解析隐写数据，实现：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pkgbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getdata</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">pkghead</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">pkgbytes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pkghead</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkghead</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">pkgbytes</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
        <span class="n">pkgbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getdata</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkgbytes</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div><ol>
<li>首先通过 <a href="#__getdata">__getdata</a> 方法从图片数据中获取存储的前8个字节数据；</li>
<li>使用 <code>int</code> 的 <code>from_bytes</code> 方法^[<a href="https://python3-cookbook.readthedocs.io/zh_CN/latest/c03/p05_pack_unpack_large_int_from_bytes.html">字节到大整数的打包与解包</a>]得到前4个字节代表的协议头；</li>
<li>比较读取的协议头是否与预设的协议头一致，若一致则进行下面的步骤，若不一致则返回结果 <code>None</code></li>
<li>同样使用 <code>int</code> 的 <code>from_bytes</code> 方法从之后的4个字节得到隐写数据的长度；</li>
<li>根据长度调用 <a href="#__getdata">__getdata</a> 方法从图片中获取隐写数据；</li>
<li>将得到的字节数组转换为编码为 <code>utf8</code> 的字符串；</li>
</ol>
<h5 id="__getdata">__getdata</h5>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">__getdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
    <span class="n">pkgbytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">r</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">v</span> <span class="o">|=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">pkgbytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pkgbytes</span>  
</code></pre></div><p>这个方法可以从图片数据中获取像素存储的位数据并组成字节数据。其中：</p>
<ul>
<li><code>start</code>：要读取字节的开始位置</li>
<li><code>stop</code>：要读取字节的结束位置</li>
</ul>
<p>所以实现中，<code>for</code> 的每一次循环读取两个像素点数据，组得一个字节数据，上述代码第 5 和第 7 行代码，得到的是每个通道的最低位数值。第 9 行代码将得到的数值转换为单字节数据。</p>
<h4 id="open方法">open方法</h4>
<p>这个方法用来打开新的图片获取 RGBA 模式的图片数据覆盖原来的属性 <code>image</code>，并记录图片路径到属性 <code>imgpath</code>，实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgpath</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">imgpath</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgpath</span> <span class="o">=</span> <span class="n">imgpath</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div><h4 id="freespace方法">freespace方法</h4>
<p>这个方法用来计算图片可存隐写数据的空间大小，单位是字节，实现如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">freespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    查看图片存储隐藏数据的可用空间，单位 byte
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;图片为空，请调用实例的 open 方法打开一张图片！&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div><p>像素个数的一半就是可存数据的空间大小，因为两个像素存一个字节数据。</p>
<h4 id="sethead方法">sethead方法</h4>
<p>有时可能需要自定义协议头，所以设计这个方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sethead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkghead</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pkghead</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkghead</span> <span class="o">=</span> <span class="n">pkghead</span>
</code></pre></div><h3 id="类测试">类测试</h3>
<p>最终实现了 <code>MessageImage</code> 类。需要测试一下，添加代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="n">MessageImage</span><span class="p">(</span><span class="s1">&#39;demo.png&#39;</span><span class="p">)</span>
    <span class="n">mi</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;你好，世界！hello, world!&#39;</span><span class="p">)</span>
    <span class="n">mi</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;demo_code.png&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">mi</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div><p>这里以图片 <a href="https://github.com/smslit/tools-with-script/blob/master/codeimg/demo.png">demo.png</a> 为例，如果最终打印了解析结果，就说明 <code>MessageImage</code> 类搞定了，类似于：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ python messageimage.py
demo_code.png 你好，世界！hello, world!
</code></pre></div><p>完整代码参考 <a href="https://github.com/smslit/tools-with-script/blob/master/codeimg/messageimage.py">tools-with-script/codeimg/messageimage.py</a></p>
<h2 id="命令行工具">命令行工具</h2>
<p>有了 MessageImage 类，命令行工具就好实现了。</p>
<h3 id="准备工作-1">准备工作</h3>
<ol>
<li>
<p>新建文件：<code>touch codeimg</code>，并为文件添加运行权限 <code>chmod +x codeimg</code></p>
</li>
<li>
<p>文件添加以下内容指定运行解释器：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python3</span>
</code></pre></div></li>
<li>
<p>这里使用 MessageImage 类和 argparse，需要导入库，文件添加：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">messageimage</span> <span class="kn">import</span> <span class="n">MessageImage</span>
</code></pre></div></li>
</ol>
<h3 id="获取参数方法">获取参数方法</h3>
<p>封装获取命令行参数的方法为 <code>getargs</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getargs</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;为图片写入隐藏信息，或者从包含隐藏信息的图片中获取信息。&#34;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;encode&#39;</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">,</span> <span class="s1">&#39;check&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;指定子命令。encode -&gt; 往图片中写入隐藏信息；decode -&gt; 读取图片中的隐藏信息；check -&gt; 查看图片可存空间(单位 byte)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--info&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;指定要写入的隐藏信息，子命令为 encode 时有效&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;imgpath&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;指定要处理的图片&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</code></pre></div><p>设置三个子命令：</p>
<ul>
<li>encode : 往图片中写入隐藏信息；</li>
<li>decode : 读取图片中的隐藏信息；</li>
<li>check : 查看图片可存空间(单位 byte)</li>
</ul>
<p><code>imgpath</code> 图片路径是必须参数。</p>
<h3 id="参数处理">参数处理</h3>
<p>最终脚本的处理如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">getargs</span><span class="p">()</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="n">MessageImage</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">imgpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;encode&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;请输入要隐藏的信息：&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mi</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">info</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;已写入隐藏信息！&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;decode&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;解析到隐藏信息：{mi.decode()}&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;check&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;图片可用空间 {mi.freespace()} bytes&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;不支持 {args.command} 命令&#39;</span><span class="p">)</span>
</code></pre></div><p>大功告成！命令行工具的代码参考：<a href="https://github.com/smslit/tools-with-script/blob/master/codeimg/codeimg">tools-with-script/codeimg/codeimg</a></p>
<h1 id="测试">测试</h1>
<p>同样以<a href="https://github.com/smslit/tools-with-script/blob/master/codeimg/demo.png">demo.png</a> 为例，测试过程如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="err">$</span> <span class="o">./</span><span class="n">codeimg</span> <span class="n">encode</span> <span class="n">demo</span><span class="o">.</span><span class="n">png</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;https://www.smslit.top&#39;</span>
<span class="n">demo_code</span><span class="o">.</span><span class="n">png</span> <span class="err">已写入隐藏信息！</span>
<span class="err">$</span> <span class="o">./</span><span class="n">codeimg</span> <span class="n">decode</span> <span class="n">demo_code</span><span class="o">.</span><span class="n">png</span>
<span class="err">解析到隐藏信息：</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">smslit</span><span class="o">.</span><span class="n">top</span>
<span class="err">$</span> <span class="o">./</span><span class="n">codeimg</span> <span class="n">check</span> <span class="n">demo</span><span class="o">.</span><span class="n">png</span>
<span class="err">图片可用空间</span> <span class="mi">381024</span> <span class="nb">bytes</span>
<span class="err">$</span> <span class="o">./</span><span class="n">codeimg</span> <span class="o">-</span><span class="n">h</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">codeimg</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="n">INFO</span><span class="p">]</span> <span class="p">{</span><span class="n">encode</span><span class="p">,</span><span class="n">decode</span><span class="p">,</span><span class="n">check</span><span class="p">}</span> <span class="n">imgpath</span>

<span class="err">为图片写入隐藏信息，或者从包含隐藏信息的图片中获取信息。</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="p">{</span><span class="n">encode</span><span class="p">,</span><span class="n">decode</span><span class="p">,</span><span class="n">check</span><span class="p">}</span>
                        <span class="err">指定子命令。</span><span class="n">encode</span> <span class="o">-&gt;</span> <span class="err">往图片中写入隐藏信息；</span><span class="n">decode</span> <span class="o">-&gt;</span> <span class="err">读取图片中的隐藏信息；</span><span class="n">check</span>
                        <span class="o">-&gt;</span> <span class="err">查看图片可存空间</span><span class="p">(</span><span class="err">单位</span> <span class="n">byte</span><span class="p">)</span>
  <span class="n">imgpath</span>               <span class="err">指定要处理的图片</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">exit</span>
  <span class="o">-</span><span class="n">i</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">--</span><span class="n">info</span> <span class="n">INFO</span>  <span class="err">指定要写入的隐藏信息，子命令为</span> <span class="n">encode</span> <span class="err">时有效</span>
</code></pre></div><h1 id="总结">总结</h1>
<p>本文实现了图片隐写术的基本功能，过程中熟悉了pillow 库、 argparse 库的基本使用以及类的编写，同时还了解了字节与字符串、字节与整型数据的相互转换。</p>
<p>如果您觉得本文写的还不错，请持续关注 <a href="https://www.smslit.top">https://www.smslit.top</a>，后面还会有好玩的东西分享！</p>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.smslit.top/tags/hacker">hacker</a></span><span class="tag"><a href="https://www.smslit.top/tags/python">python</a></span><span class="tag"><a href="https://www.smslit.top/tags/life">life</a></span>
				</p>
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
					4771 字
				</p>
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
					2018-10-20 10:09 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">目录</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#隐写术">隐写术</a></li>
    <li><a href="#数据存储">数据存储</a></li>
  </ul>

  <ul>
    <li><a href="#messageimage-类"><strong>MessageImage</strong> 类</a>
      <ul>
        <li><a href="#问题分析">问题分析</a></li>
        <li><a href="#准备工作">准备工作</a></li>
        <li><a href="#公共方法实现">公共方法实现</a></li>
        <li><a href="#类测试">类测试</a></li>
      </ul>
    </li>
    <li><a href="#命令行工具">命令行工具</a>
      <ul>
        <li><a href="#准备工作-1">准备工作</a></li>
        <li><a href="#获取参数方法">获取参数方法</a></li>
        <li><a href="#参数处理">参数处理</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.smslit.top/2018/10/21/unzip-dict-hacker/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;下一篇</span><br><span>python3 生成密码字典</span>
			</a>
			<a class="prev-post" href="https://www.smslit.top/2018/10/18/pipenv/">
				<span class="post-nav-label">上一篇&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>一起使用 pipenv</span>
			</a>
		</div>
		<div id="comments" class="thin">
		<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">打赏作者</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/assets/pay/wechatpay.png">
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/assets/pay/alipay.png">
      </label>
  </div>
</div>


<span id="/2018/10/20/codeimg-python/" class="leancloud_visitors" data-flag-title="图中藏(cáng)语">
  <span class="post-meta-item-text">访问量 </span>
  <span class="leancloud-visitors-count"></span>
  <p></p>
</span>
<div id="vcomments"></div>
<script src="/js/valine-data.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript">
  new Valine({
      el: '#vcomments' ,
      appId: 'IlJ4XQsE83q10RN3Maoglx2x-gzGzoHsz',
      appKey: 'OxVuAMUYBTbDMO9vO2IqTsMR',
      notify:  false , 
      verify:  false , 
      avatar:'', 
      placeholder: '说点什么吧...(提醒：填写邮箱，若有人回复您，您将及时收到提醒邮件！)',
      visitor:  true ,
      emojiCDN: '',
      emojiMaps: null
  });
</script>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://www.smslit.top">5km</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.smslit.top/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.smslit.top/js/main.min.35ccbf1cdceb91e4c64c06b5d009d6e2977fafe56beda7762febd4e67528d2ac.js" integrity="sha256-Ncy/HNzrkeTGTAa10AnW4pd/r+Vr7ad2L+vU5nUo0qw="></script>

	
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: {equationNumbers: {autoNumber: "AMS"}},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>

</html>
